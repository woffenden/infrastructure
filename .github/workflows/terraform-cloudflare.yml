---
  name: Terraform - Cloudflare
  
  on:
    pull_request:
      branches:
        - main
      paths:
        - .github/workflows/terraform-cloudflare.yml
        - terraform/cloudflare/**
    push:
      branches:
        - main
      paths:
        - .github/workflows/terraform-cloudflare.yml
        - terraform/cloudflare/**
    
  permissions: read-all
  
  jobs:
    cloudflare:
      name: Cloudflare
      runs-on: ubuntu-latest
      defaults:
        run:
          working-directory: terraform/cloudflare/
      permissions:
        contents: read
        id-token: write
      env:
        CLOUDFLARE_EMAIL: ${{ secrets.CLOUDFLARE_EMAIL }}
        CLOUDFLARE_API_KEY: ${{ secrets.CLOUDFLARE_API_KEY }}
      steps:
        - name: Checkout
          id: checkout
          uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
  
        - name: Configure Google Credentials
          id: configure_google_credentials
          uses: google-github-actions/auth@35b0e87d162680511bf346c299f71c9c5c379033 # v1.1.1
          with:
            workload_identity_provider: projects/800000204119/locations/global/workloadIdentityPools/github-actions/providers/github-actions
            service_account: github-actions@woffenden.iam.gserviceaccount.com

        - name: Install Terraform
          id: install_terraform
          uses: hashicorp/setup-terraform@633666f66e0061ca3b725c73b2ec20cd13a8fdd1 # v2.0.3
          with:
            terraform_version: 1.5.0

        - name: Initialise Terraform
          id: initialise_terraform
          run: terraform init -upgrade

        - name: Terraform Plan
          id: terraform_plan
          run: terraform plan

        - name: Terraform Apply
          id: terraform_apply
          if: github.ref == 'refs/heads/main'
          run: terraform apply -auto-approve
